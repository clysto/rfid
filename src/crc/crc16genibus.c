#include "crc16genibus.h"

uint16_t crc16genibus_bit(uint16_t crc, void const *mem, size_t len) {
    unsigned char const *data = mem;
    if (data == NULL)
        return 0;
    crc = ~crc;
    for (size_t i = 0; i < len; i++) {
        crc ^= (uint16_t)data[i] << 8;
        for (unsigned k = 0; k < 8; k++) {
            crc = crc & 0x8000 ? (crc << 1) ^ 0x1021 : crc << 1;
        }
    }
    crc = ~crc;
    return crc;
}

uint16_t crc16genibus_rem(uint16_t crc, unsigned val, unsigned bits) {
    crc = ~crc;
    val &= 0x100 - (0x100 >> bits) ;
    crc ^= (uint16_t)val << 8;
    for (unsigned i = 0; i < bits; i++) {
        crc = crc & 0x8000 ? (crc << 1) ^ 0x1021 : crc << 1;
    }
    crc = ~crc;
    return crc;
}

static uint16_t const table_byte[] = {
    0x1e0f, 0x0e2e, 0x3e4d, 0x2e6c, 0x5e8b, 0x4eaa, 0x7ec9, 0x6ee8, 0x9f07, 0x8f26,
    0xbf45, 0xaf64, 0xdf83, 0xcfa2, 0xffc1, 0xefe0, 0x0c3e, 0x1c1f, 0x2c7c, 0x3c5d,
    0x4cba, 0x5c9b, 0x6cf8, 0x7cd9, 0x8d36, 0x9d17, 0xad74, 0xbd55, 0xcdb2, 0xdd93,
    0xedf0, 0xfdd1, 0x3a6d, 0x2a4c, 0x1a2f, 0x0a0e, 0x7ae9, 0x6ac8, 0x5aab, 0x4a8a,
    0xbb65, 0xab44, 0x9b27, 0x8b06, 0xfbe1, 0xebc0, 0xdba3, 0xcb82, 0x285c, 0x387d,
    0x081e, 0x183f, 0x68d8, 0x78f9, 0x489a, 0x58bb, 0xa954, 0xb975, 0x8916, 0x9937,
    0xe9d0, 0xf9f1, 0xc992, 0xd9b3, 0x56cb, 0x46ea, 0x7689, 0x66a8, 0x164f, 0x066e,
    0x360d, 0x262c, 0xd7c3, 0xc7e2, 0xf781, 0xe7a0, 0x9747, 0x8766, 0xb705, 0xa724,
    0x44fa, 0x54db, 0x64b8, 0x7499, 0x047e, 0x145f, 0x243c, 0x341d, 0xc5f2, 0xd5d3,
    0xe5b0, 0xf591, 0x8576, 0x9557, 0xa534, 0xb515, 0x72a9, 0x6288, 0x52eb, 0x42ca,
    0x322d, 0x220c, 0x126f, 0x024e, 0xf3a1, 0xe380, 0xd3e3, 0xc3c2, 0xb325, 0xa304,
    0x9367, 0x8346, 0x6098, 0x70b9, 0x40da, 0x50fb, 0x201c, 0x303d, 0x005e, 0x107f,
    0xe190, 0xf1b1, 0xc1d2, 0xd1f3, 0xa114, 0xb135, 0x8156, 0x9177, 0x8f87, 0x9fa6,
    0xafc5, 0xbfe4, 0xcf03, 0xdf22, 0xef41, 0xff60, 0x0e8f, 0x1eae, 0x2ecd, 0x3eec,
    0x4e0b, 0x5e2a, 0x6e49, 0x7e68, 0x9db6, 0x8d97, 0xbdf4, 0xadd5, 0xdd32, 0xcd13,
    0xfd70, 0xed51, 0x1cbe, 0x0c9f, 0x3cfc, 0x2cdd, 0x5c3a, 0x4c1b, 0x7c78, 0x6c59,
    0xabe5, 0xbbc4, 0x8ba7, 0x9b86, 0xeb61, 0xfb40, 0xcb23, 0xdb02, 0x2aed, 0x3acc,
    0x0aaf, 0x1a8e, 0x6a69, 0x7a48, 0x4a2b, 0x5a0a, 0xb9d4, 0xa9f5, 0x9996, 0x89b7,
    0xf950, 0xe971, 0xd912, 0xc933, 0x38dc, 0x28fd, 0x189e, 0x08bf, 0x7858, 0x6879,
    0x581a, 0x483b, 0xc743, 0xd762, 0xe701, 0xf720, 0x87c7, 0x97e6, 0xa785, 0xb7a4,
    0x464b, 0x566a, 0x6609, 0x7628, 0x06cf, 0x16ee, 0x268d, 0x36ac, 0xd572, 0xc553,
    0xf530, 0xe511, 0x95f6, 0x85d7, 0xb5b4, 0xa595, 0x547a, 0x445b, 0x7438, 0x6419,
    0x14fe, 0x04df, 0x34bc, 0x249d, 0xe321, 0xf300, 0xc363, 0xd342, 0xa3a5, 0xb384,
    0x83e7, 0x93c6, 0x6229, 0x7208, 0x426b, 0x524a, 0x22ad, 0x328c, 0x02ef, 0x12ce,
    0xf110, 0xe131, 0xd152, 0xc173, 0xb194, 0xa1b5, 0x91d6, 0x81f7, 0x7018, 0x6039,
    0x505a, 0x407b, 0x309c, 0x20bd, 0x10de, 0x00ff
};

static uint16_t const table_word[][256] = {
   {0x0f1e, 0x2e0e, 0x4d3e, 0x6c2e, 0x8b5e, 0xaa4e, 0xc97e, 0xe86e, 0x079f, 0x268f,
    0x45bf, 0x64af, 0x83df, 0xa2cf, 0xc1ff, 0xe0ef, 0x3e0c, 0x1f1c, 0x7c2c, 0x5d3c,
    0xba4c, 0x9b5c, 0xf86c, 0xd97c, 0x368d, 0x179d, 0x74ad, 0x55bd, 0xb2cd, 0x93dd,
    0xf0ed, 0xd1fd, 0x6d3a, 0x4c2a, 0x2f1a, 0x0e0a, 0xe97a, 0xc86a, 0xab5a, 0x8a4a,
    0x65bb, 0x44ab, 0x279b, 0x068b, 0xe1fb, 0xc0eb, 0xa3db, 0x82cb, 0x5c28, 0x7d38,
    0x1e08, 0x3f18, 0xd868, 0xf978, 0x9a48, 0xbb58, 0x54a9, 0x75b9, 0x1689, 0x3799,
    0xd0e9, 0xf1f9, 0x92c9, 0xb3d9, 0xcb56, 0xea46, 0x8976, 0xa866, 0x4f16, 0x6e06,
    0x0d36, 0x2c26, 0xc3d7, 0xe2c7, 0x81f7, 0xa0e7, 0x4797, 0x6687, 0x05b7, 0x24a7,
    0xfa44, 0xdb54, 0xb864, 0x9974, 0x7e04, 0x5f14, 0x3c24, 0x1d34, 0xf2c5, 0xd3d5,
    0xb0e5, 0x91f5, 0x7685, 0x5795, 0x34a5, 0x15b5, 0xa972, 0x8862, 0xeb52, 0xca42,
    0x2d32, 0x0c22, 0x6f12, 0x4e02, 0xa1f3, 0x80e3, 0xe3d3, 0xc2c3, 0x25b3, 0x04a3,
    0x6793, 0x4683, 0x9860, 0xb970, 0xda40, 0xfb50, 0x1c20, 0x3d30, 0x5e00, 0x7f10,
    0x90e1, 0xb1f1, 0xd2c1, 0xf3d1, 0x14a1, 0x35b1, 0x5681, 0x7791, 0x878f, 0xa69f,
    0xc5af, 0xe4bf, 0x03cf, 0x22df, 0x41ef, 0x60ff, 0x8f0e, 0xae1e, 0xcd2e, 0xec3e,
    0x0b4e, 0x2a5e, 0x496e, 0x687e, 0xb69d, 0x978d, 0xf4bd, 0xd5ad, 0x32dd, 0x13cd,
    0x70fd, 0x51ed, 0xbe1c, 0x9f0c, 0xfc3c, 0xdd2c, 0x3a5c, 0x1b4c, 0x787c, 0x596c,
    0xe5ab, 0xc4bb, 0xa78b, 0x869b, 0x61eb, 0x40fb, 0x23cb, 0x02db, 0xed2a, 0xcc3a,
    0xaf0a, 0x8e1a, 0x696a, 0x487a, 0x2b4a, 0x0a5a, 0xd4b9, 0xf5a9, 0x9699, 0xb789,
    0x50f9, 0x71e9, 0x12d9, 0x33c9, 0xdc38, 0xfd28, 0x9e18, 0xbf08, 0x5878, 0x7968,
    0x1a58, 0x3b48, 0x43c7, 0x62d7, 0x01e7, 0x20f7, 0xc787, 0xe697, 0x85a7, 0xa4b7,
    0x4b46, 0x6a56, 0x0966, 0x2876, 0xcf06, 0xee16, 0x8d26, 0xac36, 0x72d5, 0x53c5,
    0x30f5, 0x11e5, 0xf695, 0xd785, 0xb4b5, 0x95a5, 0x7a54, 0x5b44, 0x3874, 0x1964,
    0xfe14, 0xdf04, 0xbc34, 0x9d24, 0x21e3, 0x00f3, 0x63c3, 0x42d3, 0xa5a3, 0x84b3,
    0xe783, 0xc693, 0x2962, 0x0872, 0x6b42, 0x4a52, 0xad22, 0x8c32, 0xef02, 0xce12,
    0x10f1, 0x31e1, 0x52d1, 0x73c1, 0x94b1, 0xb5a1, 0xd691, 0xf781, 0x1870, 0x3960,
    0x5a50, 0x7b40, 0x9c30, 0xbd20, 0xde10, 0xff00},
   {0xfffc, 0xcecf, 0x9d9a, 0xaca9, 0x3b30, 0x0a03, 0x5956, 0x6865, 0x5675, 0x6746,
    0x3413, 0x0520, 0x92b9, 0xa38a, 0xf0df, 0xc1ec, 0x8cff, 0xbdcc, 0xee99, 0xdfaa,
    0x4833, 0x7900, 0x2a55, 0x1b66, 0x2576, 0x1445, 0x4710, 0x7623, 0xe1ba, 0xd089,
    0x83dc, 0xb2ef, 0x19fa, 0x28c9, 0x7b9c, 0x4aaf, 0xdd36, 0xec05, 0xbf50, 0x8e63,
    0xb073, 0x8140, 0xd215, 0xe326, 0x74bf, 0x458c, 0x16d9, 0x27ea, 0x6af9, 0x5bca,
    0x089f, 0x39ac, 0xae35, 0x9f06, 0xcc53, 0xfd60, 0xc370, 0xf243, 0xa116, 0x9025,
    0x07bc, 0x368f, 0x65da, 0x54e9, 0x33f1, 0x02c2, 0x5197, 0x60a4, 0xf73d, 0xc60e,
    0x955b, 0xa468, 0x9a78, 0xab4b, 0xf81e, 0xc92d, 0x5eb4, 0x6f87, 0x3cd2, 0x0de1,
    0x40f2, 0x71c1, 0x2294, 0x13a7, 0x843e, 0xb50d, 0xe658, 0xd76b, 0xe97b, 0xd848,
    0x8b1d, 0xba2e, 0x2db7, 0x1c84, 0x4fd1, 0x7ee2, 0xd5f7, 0xe4c4, 0xb791, 0x86a2,
    0x113b, 0x2008, 0x735d, 0x426e, 0x7c7e, 0x4d4d, 0x1e18, 0x2f2b, 0xb8b2, 0x8981,
    0xdad4, 0xebe7, 0xa6f4, 0x97c7, 0xc492, 0xf5a1, 0x6238, 0x530b, 0x005e, 0x316d,
    0x0f7d, 0x3e4e, 0x6d1b, 0x5c28, 0xcbb1, 0xfa82, 0xa9d7, 0x98e4, 0x67e7, 0x56d4,
    0x0581, 0x34b2, 0xa32b, 0x9218, 0xc14d, 0xf07e, 0xce6e, 0xff5d, 0xac08, 0x9d3b,
    0x0aa2, 0x3b91, 0x68c4, 0x59f7, 0x14e4, 0x25d7, 0x7682, 0x47b1, 0xd028, 0xe11b,
    0xb24e, 0x837d, 0xbd6d, 0x8c5e, 0xdf0b, 0xee38, 0x79a1, 0x4892, 0x1bc7, 0x2af4,
    0x81e1, 0xb0d2, 0xe387, 0xd2b4, 0x452d, 0x741e, 0x274b, 0x1678, 0x2868, 0x195b,
    0x4a0e, 0x7b3d, 0xeca4, 0xdd97, 0x8ec2, 0xbff1, 0xf2e2, 0xc3d1, 0x9084, 0xa1b7,
    0x362e, 0x071d, 0x5448, 0x657b, 0x5b6b, 0x6a58, 0x390d, 0x083e, 0x9fa7, 0xae94,
    0xfdc1, 0xccf2, 0xabea, 0x9ad9, 0xc98c, 0xf8bf, 0x6f26, 0x5e15, 0x0d40, 0x3c73,
    0x0263, 0x3350, 0x6005, 0x5136, 0xc6af, 0xf79c, 0xa4c9, 0x95fa, 0xd8e9, 0xe9da,
    0xba8f, 0x8bbc, 0x1c25, 0x2d16, 0x7e43, 0x4f70, 0x7160, 0x4053, 0x1306, 0x2235,
    0xb5ac, 0x849f, 0xd7ca, 0xe6f9, 0x4dec, 0x7cdf, 0x2f8a, 0x1eb9, 0x8920, 0xb813,
    0xeb46, 0xda75, 0xe465, 0xd556, 0x8603, 0xb730, 0x20a9, 0x119a, 0x42cf, 0x73fc,
    0x3eef, 0x0fdc, 0x5c89, 0x6dba, 0xfa23, 0xcb10, 0x9845, 0xa976, 0x9766, 0xa655,
    0xf500, 0xc433, 0x53aa, 0x6299, 0x31cc, 0x00ff},
   {0x93d1, 0xa3e6, 0xf3bf, 0xc388, 0x530d, 0x633a, 0x3363, 0x0354, 0x3278, 0x024f,
    0x5216, 0x6221, 0xf2a4, 0xc293, 0x92ca, 0xa2fd, 0xf092, 0xc0a5, 0x90fc, 0xa0cb,
    0x304e, 0x0079, 0x5020, 0x6017, 0x513b, 0x610c, 0x3155, 0x0162, 0x91e7, 0xa1d0,
    0xf189, 0xc1be, 0x5557, 0x6560, 0x3539, 0x050e, 0x958b, 0xa5bc, 0xf5e5, 0xc5d2,
    0xf4fe, 0xc4c9, 0x9490, 0xa4a7, 0x3422, 0x0415, 0x544c, 0x647b, 0x3614, 0x0623,
    0x567a, 0x664d, 0xf6c8, 0xc6ff, 0x96a6, 0xa691, 0x97bd, 0xa78a, 0xf7d3, 0xc7e4,
    0x5761, 0x6756, 0x370f, 0x0738, 0x3ecc, 0x0efb, 0x5ea2, 0x6e95, 0xfe10, 0xce27,
    0x9e7e, 0xae49, 0x9f65, 0xaf52, 0xff0b, 0xcf3c, 0x5fb9, 0x6f8e, 0x3fd7, 0x0fe0,
    0x5d8f, 0x6db8, 0x3de1, 0x0dd6, 0x9d53, 0xad64, 0xfd3d, 0xcd0a, 0xfc26, 0xcc11,
    0x9c48, 0xac7f, 0x3cfa, 0x0ccd, 0x5c94, 0x6ca3, 0xf84a, 0xc87d, 0x9824, 0xa813,
    0x3896, 0x08a1, 0x58f8, 0x68cf, 0x59e3, 0x69d4, 0x398d, 0x09ba, 0x993f, 0xa908,
    0xf951, 0xc966, 0x9b09, 0xab3e, 0xfb67, 0xcb50, 0x5bd5, 0x6be2, 0x3bbb, 0x0b8c,
    0x3aa0, 0x0a97, 0x5ace, 0x6af9, 0xfa7c, 0xca4b, 0x9a12, 0xaa25, 0xc9ea, 0xf9dd,
    0xa984, 0x99b3, 0x0936, 0x3901, 0x6958, 0x596f, 0x6843, 0x5874, 0x082d, 0x381a,
    0xa89f, 0x98a8, 0xc8f1, 0xf8c6, 0xaaa9, 0x9a9e, 0xcac7, 0xfaf0, 0x6a75, 0x5a42,
    0x0a1b, 0x3a2c, 0x0b00, 0x3b37, 0x6b6e, 0x5b59, 0xcbdc, 0xfbeb, 0xabb2, 0x9b85,
    0x0f6c, 0x3f5b, 0x6f02, 0x5f35, 0xcfb0, 0xff87, 0xafde, 0x9fe9, 0xaec5, 0x9ef2,
    0xceab, 0xfe9c, 0x6e19, 0x5e2e, 0x0e77, 0x3e40, 0x6c2f, 0x5c18, 0x0c41, 0x3c76,
    0xacf3, 0x9cc4, 0xcc9d, 0xfcaa, 0xcd86, 0xfdb1, 0xade8, 0x9ddf, 0x0d5a, 0x3d6d,
    0x6d34, 0x5d03, 0x64f7, 0x54c0, 0x0499, 0x34ae, 0xa42b, 0x941c, 0xc445, 0xf472,
    0xc55e, 0xf569, 0xa530, 0x9507, 0x0582, 0x35b5, 0x65ec, 0x55db, 0x07b4, 0x3783,
    0x67da, 0x57ed, 0xc768, 0xf75f, 0xa706, 0x9731, 0xa61d, 0x962a, 0xc673, 0xf644,
    0x66c1, 0x56f6, 0x06af, 0x3698, 0xa271, 0x9246, 0xc21f, 0xf228, 0x62ad, 0x529a,
    0x02c3, 0x32f4, 0x03d8, 0x33ef, 0x63b6, 0x5381, 0xc304, 0xf333, 0xa36a, 0x935d,
    0xc132, 0xf105, 0xa15c, 0x916b, 0x01ee, 0x31d9, 0x6180, 0x51b7, 0x609b, 0x50ac,
    0x00f5, 0x30c2, 0xa047, 0x9070, 0xc029, 0xf01e},
   {0x5c48, 0xe83e, 0x34a5, 0x80d3, 0xad82, 0x19f4, 0xc56f, 0x7119, 0x9fcd, 0x2bbb,
    0xf720, 0x4356, 0x6e07, 0xda71, 0x06ea, 0xb29c, 0xfb53, 0x4f25, 0x93be, 0x27c8,
    0x0a99, 0xbeef, 0x6274, 0xd602, 0x38d6, 0x8ca0, 0x503b, 0xe44d, 0xc91c, 0x7d6a,
    0xa1f1, 0x1587, 0x127f, 0xa609, 0x7a92, 0xcee4, 0xe3b5, 0x57c3, 0x8b58, 0x3f2e,
    0xd1fa, 0x658c, 0xb917, 0x0d61, 0x2030, 0x9446, 0x48dd, 0xfcab, 0xb564, 0x0112,
    0xdd89, 0x69ff, 0x44ae, 0xf0d8, 0x2c43, 0x9835, 0x76e1, 0xc297, 0x1e0c, 0xaa7a,
    0x872b, 0x335d, 0xefc6, 0x5bb0, 0xc026, 0x7450, 0xa8cb, 0x1cbd, 0x31ec, 0x859a,
    0x5901, 0xed77, 0x03a3, 0xb7d5, 0x6b4e, 0xdf38, 0xf269, 0x461f, 0x9a84, 0x2ef2,
    0x673d, 0xd34b, 0x0fd0, 0xbba6, 0x96f7, 0x2281, 0xfe1a, 0x4a6c, 0xa4b8, 0x10ce,
    0xcc55, 0x7823, 0x5572, 0xe104, 0x3d9f, 0x89e9, 0x8e11, 0x3a67, 0xe6fc, 0x528a,
    0x7fdb, 0xcbad, 0x1736, 0xa340, 0x4d94, 0xf9e2, 0x2579, 0x910f, 0xbc5e, 0x0828,
    0xd4b3, 0x60c5, 0x290a, 0x9d7c, 0x41e7, 0xf591, 0xd8c0, 0x6cb6, 0xb02d, 0x045b,
    0xea8f, 0x5ef9, 0x8262, 0x3614, 0x1b45, 0xaf33, 0x73a8, 0xc7de, 0x6495, 0xd0e3,
    0x0c78, 0xb80e, 0x955f, 0x2129, 0xfdb2, 0x49c4, 0xa710, 0x1366, 0xcffd, 0x7b8b,
    0x56da, 0xe2ac, 0x3e37, 0x8a41, 0xc38e, 0x77f8, 0xab63, 0x1f15, 0x3244, 0x8632,
    0x5aa9, 0xeedf, 0x000b, 0xb47d, 0x68e6, 0xdc90, 0xf1c1, 0x45b7, 0x992c, 0x2d5a,
    0x2aa2, 0x9ed4, 0x424f, 0xf639, 0xdb68, 0x6f1e, 0xb385, 0x07f3, 0xe927, 0x5d51,
    0x81ca, 0x35bc, 0x18ed, 0xac9b, 0x7000, 0xc476, 0x8db9, 0x39cf, 0xe554, 0x5122,
    0x7c73, 0xc805, 0x149e, 0xa0e8, 0x4e3c, 0xfa4a, 0x26d1, 0x92a7, 0xbff6, 0x0b80,
    0xd71b, 0x636d, 0xf8fb, 0x4c8d, 0x9016, 0x2460, 0x0931, 0xbd47, 0x61dc, 0xd5aa,
    0x3b7e, 0x8f08, 0x5393, 0xe7e5, 0xcab4, 0x7ec2, 0xa259, 0x162f, 0x5fe0, 0xeb96,
    0x370d, 0x837b, 0xae2a, 0x1a5c, 0xc6c7, 0x72b1, 0x9c65, 0x2813, 0xf488, 0x40fe,
    0x6daf, 0xd9d9, 0x0542, 0xb134, 0xb6cc, 0x02ba, 0xde21, 0x6a57, 0x4706, 0xf370,
    0x2feb, 0x9b9d, 0x7549, 0xc13f, 0x1da4, 0xa9d2, 0x8483, 0x30f5, 0xec6e, 0x5818,
    0x11d7, 0xa5a1, 0x793a, 0xcd4c, 0xe01d, 0x546b, 0x88f0, 0x3c86, 0xd252, 0x6624,
    0xbabf, 0x0ec9, 0x2398, 0x97ee, 0x4b75, 0xff03},
   {0xcc95, 0x9d3f, 0x4fd1, 0x1e7b, 0xca1c, 0x9bb6, 0x4958, 0x18f2, 0xe197, 0xb03d,
    0x62d3, 0x3379, 0xe71e, 0xb6b4, 0x645a, 0x35f0, 0x9691, 0xc73b, 0x15d5, 0x447f,
    0x9018, 0xc1b2, 0x135c, 0x42f6, 0xbb93, 0xea39, 0x38d7, 0x697d, 0xbd1a, 0xecb0,
    0x3e5e, 0x6ff4, 0x789d, 0x2937, 0xfbd9, 0xaa73, 0x7e14, 0x2fbe, 0xfd50, 0xacfa,
    0x559f, 0x0435, 0xd6db, 0x8771, 0x5316, 0x02bc, 0xd052, 0x81f8, 0x2299, 0x7333,
    0xa1dd, 0xf077, 0x2410, 0x75ba, 0xa754, 0xf6fe, 0x0f9b, 0x5e31, 0x8cdf, 0xdd75,
    0x0912, 0x58b8, 0x8a56, 0xdbfc, 0xa484, 0xf52e, 0x27c0, 0x766a, 0xa20d, 0xf3a7,
    0x2149, 0x70e3, 0x8986, 0xd82c, 0x0ac2, 0x5b68, 0x8f0f, 0xdea5, 0x0c4b, 0x5de1,
    0xfe80, 0xaf2a, 0x7dc4, 0x2c6e, 0xf809, 0xa9a3, 0x7b4d, 0x2ae7, 0xd382, 0x8228,
    0x50c6, 0x016c, 0xd50b, 0x84a1, 0x564f, 0x07e5, 0x108c, 0x4126, 0x93c8, 0xc262,
    0x1605, 0x47af, 0x9541, 0xc4eb, 0x3d8e, 0x6c24, 0xbeca, 0xef60, 0x3b07, 0x6aad,
    0xb843, 0xe9e9, 0x4a88, 0x1b22, 0xc9cc, 0x9866, 0x4c01, 0x1dab, 0xcf45, 0x9eef,
    0x678a, 0x3620, 0xe4ce, 0xb564, 0x6103, 0x30a9, 0xe247, 0xb3ed, 0x1cb7, 0x4d1d,
    0x9ff3, 0xce59, 0x1a3e, 0x4b94, 0x997a, 0xc8d0, 0x31b5, 0x601f, 0xb2f1, 0xe35b,
    0x373c, 0x6696, 0xb478, 0xe5d2, 0x46b3, 0x1719, 0xc5f7, 0x945d, 0x403a, 0x1190,
    0xc37e, 0x92d4, 0x6bb1, 0x3a1b, 0xe8f5, 0xb95f, 0x6d38, 0x3c92, 0xee7c, 0xbfd6,
    0xa8bf, 0xf915, 0x2bfb, 0x7a51, 0xae36, 0xff9c, 0x2d72, 0x7cd8, 0x85bd, 0xd417,
    0x06f9, 0x5753, 0x8334, 0xd29e, 0x0070, 0x51da, 0xf2bb, 0xa311, 0x71ff, 0x2055,
    0xf432, 0xa598, 0x7776, 0x26dc, 0xdfb9, 0x8e13, 0x5cfd, 0x0d57, 0xd930, 0x889a,
    0x5a74, 0x0bde, 0x74a6, 0x250c, 0xf7e2, 0xa648, 0x722f, 0x2385, 0xf16b, 0xa0c1,
    0x59a4, 0x080e, 0xdae0, 0x8b4a, 0x5f2d, 0x0e87, 0xdc69, 0x8dc3, 0x2ea2, 0x7f08,
    0xade6, 0xfc4c, 0x282b, 0x7981, 0xab6f, 0xfac5, 0x03a0, 0x520a, 0x80e4, 0xd14e,
    0x0529, 0x5483, 0x866d, 0xd7c7, 0xc0ae, 0x9104, 0x43ea, 0x1240, 0xc627, 0x978d,
    0x4563, 0x14c9, 0xedac, 0xbc06, 0x6ee8, 0x3f42, 0xeb25, 0xba8f, 0x6861, 0x39cb,
    0x9aaa, 0xcb00, 0x19ee, 0x4844, 0x9c23, 0xcd89, 0x1f67, 0x4ecd, 0xb7a8, 0xe602,
    0x34ec, 0x6546, 0xb121, 0xe08b, 0x3265, 0x63cf},
   {0x1c1f, 0xbc5a, 0x5c94, 0xfcd1, 0xbd19, 0x1d5c, 0xfd92, 0x5dd7, 0x5e12, 0xfe57,
    0x1e99, 0xbedc, 0xff14, 0x5f51, 0xbf9f, 0x1fda, 0x9805, 0x3840, 0xd88e, 0x78cb,
    0x3903, 0x9946, 0x7988, 0xd9cd, 0xda08, 0x7a4d, 0x9a83, 0x3ac6, 0x7b0e, 0xdb4b,
    0x3b85, 0x9bc0, 0x142a, 0xb46f, 0x54a1, 0xf4e4, 0xb52c, 0x1569, 0xf5a7, 0x55e2,
    0x5627, 0xf662, 0x16ac, 0xb6e9, 0xf721, 0x5764, 0xb7aa, 0x17ef, 0x9030, 0x3075,
    0xd0bb, 0x70fe, 0x3136, 0x9173, 0x71bd, 0xd1f8, 0xd23d, 0x7278, 0x92b6, 0x32f3,
    0x733b, 0xd37e, 0x33b0, 0x93f5, 0x0c75, 0xac30, 0x4cfe, 0xecbb, 0xad73, 0x0d36,
    0xedf8, 0x4dbd, 0x4e78, 0xee3d, 0x0ef3, 0xaeb6, 0xef7e, 0x4f3b, 0xaff5, 0x0fb0,
    0x886f, 0x282a, 0xc8e4, 0x68a1, 0x2969, 0x892c, 0x69e2, 0xc9a7, 0xca62, 0x6a27,
    0x8ae9, 0x2aac, 0x6b64, 0xcb21, 0x2bef, 0x8baa, 0x0440, 0xa405, 0x44cb, 0xe48e,
    0xa546, 0x0503, 0xe5cd, 0x4588, 0x464d, 0xe608, 0x06c6, 0xa683, 0xe74b, 0x470e,
    0xa7c0, 0x0785, 0x805a, 0x201f, 0xc0d1, 0x6094, 0x215c, 0x8119, 0x61d7, 0xc192,
    0xc257, 0x6212, 0x82dc, 0x2299, 0x6351, 0xc314, 0x23da, 0x839f, 0x3ccb, 0x9c8e,
    0x7c40, 0xdc05, 0x9dcd, 0x3d88, 0xdd46, 0x7d03, 0x7ec6, 0xde83, 0x3e4d, 0x9e08,
    0xdfc0, 0x7f85, 0x9f4b, 0x3f0e, 0xb8d1, 0x1894, 0xf85a, 0x581f, 0x19d7, 0xb992,
    0x595c, 0xf919, 0xfadc, 0x5a99, 0xba57, 0x1a12, 0x5bda, 0xfb9f, 0x1b51, 0xbb14,
    0x34fe, 0x94bb, 0x7475, 0xd430, 0x95f8, 0x35bd, 0xd573, 0x7536, 0x76f3, 0xd6b6,
    0x3678, 0x963d, 0xd7f5, 0x77b0, 0x977e, 0x373b, 0xb0e4, 0x10a1, 0xf06f, 0x502a,
    0x11e2, 0xb1a7, 0x5169, 0xf12c, 0xf2e9, 0x52ac, 0xb262, 0x1227, 0x53ef, 0xf3aa,
    0x1364, 0xb321, 0x2ca1, 0x8ce4, 0x6c2a, 0xcc6f, 0x8da7, 0x2de2, 0xcd2c, 0x6d69,
    0x6eac, 0xcee9, 0x2e27, 0x8e62, 0xcfaa, 0x6fef, 0x8f21, 0x2f64, 0xa8bb, 0x08fe,
    0xe830, 0x4875, 0x09bd, 0xa9f8, 0x4936, 0xe973, 0xeab6, 0x4af3, 0xaa3d, 0x0a78,
    0x4bb0, 0xebf5, 0x0b3b, 0xab7e, 0x2494, 0x84d1, 0x641f, 0xc45a, 0x8592, 0x25d7,
    0xc519, 0x655c, 0x6699, 0xc6dc, 0x2612, 0x8657, 0xc79f, 0x67da, 0x8714, 0x2751,
    0xa08e, 0x00cb, 0xe005, 0x4040, 0x0188, 0xa1cd, 0x4103, 0xe146, 0xe283, 0x42c6,
    0xa208, 0x024d, 0x4385, 0xe3c0, 0x030e, 0xa34b},
   {0xdeff, 0xbf47, 0x3d9f, 0x5c27, 0x183e, 0x7986, 0xfb5e, 0x9ae6, 0x736c, 0x12d4,
    0x900c, 0xf1b4, 0xb5ad, 0xd415, 0x56cd, 0x3775, 0xa5c8, 0xc470, 0x46a8, 0x2710,
    0x6309, 0x02b1, 0x8069, 0xe1d1, 0x085b, 0x69e3, 0xeb3b, 0x8a83, 0xce9a, 0xaf22,
    0x2dfa, 0x4c42, 0x2891, 0x4929, 0xcbf1, 0xaa49, 0xee50, 0x8fe8, 0x0d30, 0x6c88,
    0x8502, 0xe4ba, 0x6662, 0x07da, 0x43c3, 0x227b, 0xa0a3, 0xc11b, 0x53a6, 0x321e,
    0xb0c6, 0xd17e, 0x9567, 0xf4df, 0x7607, 0x17bf, 0xfe35, 0x9f8d, 0x1d55, 0x7ced,
    0x38f4, 0x594c, 0xdb94, 0xba2c, 0x3222, 0x539a, 0xd142, 0xb0fa, 0xf4e3, 0x955b,
    0x1783, 0x763b, 0x9fb1, 0xfe09, 0x7cd1, 0x1d69, 0x5970, 0x38c8, 0xba10, 0xdba8,
    0x4915, 0x28ad, 0xaa75, 0xcbcd, 0x8fd4, 0xee6c, 0x6cb4, 0x0d0c, 0xe486, 0x853e,
    0x07e6, 0x665e, 0x2247, 0x43ff, 0xc127, 0xa09f, 0xc44c, 0xa5f4, 0x272c, 0x4694,
    0x028d, 0x6335, 0xe1ed, 0x8055, 0x69df, 0x0867, 0x8abf, 0xeb07, 0xaf1e, 0xcea6,
    0x4c7e, 0x2dc6, 0xbf7b, 0xdec3, 0x5c1b, 0x3da3, 0x79ba, 0x1802, 0x9ada, 0xfb62,
    0x12e8, 0x7350, 0xf188, 0x9030, 0xd429, 0xb591, 0x3749, 0x56f1, 0x2754, 0x46ec,
    0xc434, 0xa58c, 0xe195, 0x802d, 0x02f5, 0x634d, 0x8ac7, 0xeb7f, 0x69a7, 0x081f,
    0x4c06, 0x2dbe, 0xaf66, 0xcede, 0x5c63, 0x3ddb, 0xbf03, 0xdebb, 0x9aa2, 0xfb1a,
    0x79c2, 0x187a, 0xf1f0, 0x9048, 0x1290, 0x7328, 0x3731, 0x5689, 0xd451, 0xb5e9,
    0xd13a, 0xb082, 0x325a, 0x53e2, 0x17fb, 0x7643, 0xf49b, 0x9523, 0x7ca9, 0x1d11,
    0x9fc9, 0xfe71, 0xba68, 0xdbd0, 0x5908, 0x38b0, 0xaa0d, 0xcbb5, 0x496d, 0x28d5,
    0x6ccc, 0x0d74, 0x8fac, 0xee14, 0x079e, 0x6626, 0xe4fe, 0x8546, 0xc15f, 0xa0e7,
    0x223f, 0x4387, 0xcb89, 0xaa31, 0x28e9, 0x4951, 0x0d48, 0x6cf0, 0xee28, 0x8f90,
    0x661a, 0x07a2, 0x857a, 0xe4c2, 0xa0db, 0xc163, 0x43bb, 0x2203, 0xb0be, 0xd106,
    0x53de, 0x3266, 0x767f, 0x17c7, 0x951f, 0xf4a7, 0x1d2d, 0x7c95, 0xfe4d, 0x9ff5,
    0xdbec, 0xba54, 0x388c, 0x5934, 0x3de7, 0x5c5f, 0xde87, 0xbf3f, 0xfb26, 0x9a9e,
    0x1846, 0x79fe, 0x9074, 0xf1cc, 0x7314, 0x12ac, 0x56b5, 0x370d, 0xb5d5, 0xd46d,
    0x46d0, 0x2768, 0xa5b0, 0xc408, 0x8011, 0xe1a9, 0x6371, 0x02c9, 0xeb43, 0x8afb,
    0x0823, 0x699b, 0x2d82, 0x4c3a, 0xcee2, 0xaf5a},
   {0xf0c0, 0x2387, 0x564f, 0x8508, 0x9dcf, 0x4e88, 0x3b40, 0xe807, 0x2ade, 0xf999,
    0x8c51, 0x5f16, 0x47d1, 0x9496, 0xe15e, 0x3219, 0x44fd, 0x97ba, 0xe272, 0x3135,
    0x29f2, 0xfab5, 0x8f7d, 0x5c3a, 0x9ee3, 0x4da4, 0x386c, 0xeb2b, 0xf3ec, 0x20ab,
    0x5563, 0x8624, 0x98bb, 0x4bfc, 0x3e34, 0xed73, 0xf5b4, 0x26f3, 0x533b, 0x807c,
    0x42a5, 0x91e2, 0xe42a, 0x376d, 0x2faa, 0xfced, 0x8925, 0x5a62, 0x2c86, 0xffc1,
    0x8a09, 0x594e, 0x4189, 0x92ce, 0xe706, 0x3441, 0xf698, 0x25df, 0x5017, 0x8350,
    0x9b97, 0x48d0, 0x3d18, 0xee5f, 0x2036, 0xf371, 0x86b9, 0x55fe, 0x4d39, 0x9e7e,
    0xebb6, 0x38f1, 0xfa28, 0x296f, 0x5ca7, 0x8fe0, 0x9727, 0x4460, 0x31a8, 0xe2ef,
    0x940b, 0x474c, 0x3284, 0xe1c3, 0xf904, 0x2a43, 0x5f8b, 0x8ccc, 0x4e15, 0x9d52,
    0xe89a, 0x3bdd, 0x231a, 0xf05d, 0x8595, 0x56d2, 0x484d, 0x9b0a, 0xeec2, 0x3d85,
    0x2542, 0xf605, 0x83cd, 0x508a, 0x9253, 0x4114, 0x34dc, 0xe79b, 0xff5c, 0x2c1b,
    0x59d3, 0x8a94, 0xfc70, 0x2f37, 0x5aff, 0x89b8, 0x917f, 0x4238, 0x37f0, 0xe4b7,
    0x266e, 0xf529, 0x80e1, 0x53a6, 0x4b61, 0x9826, 0xedee, 0x3ea9, 0x713d, 0xa27a,
    0xd7b2, 0x04f5, 0x1c32, 0xcf75, 0xbabd, 0x69fa, 0xab23, 0x7864, 0x0dac, 0xdeeb,
    0xc62c, 0x156b, 0x60a3, 0xb3e4, 0xc500, 0x1647, 0x638f, 0xb0c8, 0xa80f, 0x7b48,
    0x0e80, 0xddc7, 0x1f1e, 0xcc59, 0xb991, 0x6ad6, 0x7211, 0xa156, 0xd49e, 0x07d9,
    0x1946, 0xca01, 0xbfc9, 0x6c8e, 0x7449, 0xa70e, 0xd2c6, 0x0181, 0xc358, 0x101f,
    0x65d7, 0xb690, 0xae57, 0x7d10, 0x08d8, 0xdb9f, 0xad7b, 0x7e3c, 0x0bf4, 0xd8b3,
    0xc074, 0x1333, 0x66fb, 0xb5bc, 0x7765, 0xa422, 0xd1ea, 0x02ad, 0x1a6a, 0xc92d,
    0xbce5, 0x6fa2, 0xa1cb, 0x728c, 0x0744, 0xd403, 0xccc4, 0x1f83, 0x6a4b, 0xb90c,
    0x7bd5, 0xa892, 0xdd5a, 0x0e1d, 0x16da, 0xc59d, 0xb055, 0x6312, 0x15f6, 0xc6b1,
    0xb379, 0x603e, 0x78f9, 0xabbe, 0xde76, 0x0d31, 0xcfe8, 0x1caf, 0x6967, 0xba20,
    0xa2e7, 0x71a0, 0x0468, 0xd72f, 0xc9b0, 0x1af7, 0x6f3f, 0xbc78, 0xa4bf, 0x77f8,
    0x0230, 0xd177, 0x13ae, 0xc0e9, 0xb521, 0x6666, 0x7ea1, 0xade6, 0xd82e, 0x0b69,
    0x7d8d, 0xaeca, 0xdb02, 0x0845, 0x1082, 0xc3c5, 0xb60d, 0x654a, 0xa793, 0x74d4,
    0x011c, 0xd25b, 0xca9c, 0x19db, 0x6c13, 0xbf54}
};

uint16_t crc16genibus_byte(uint16_t crc, void const *mem, size_t len) {
    unsigned char const *data = mem;
    if (data == NULL)
        return 0;
    for (size_t i = 0; i < len; i++) {
        crc = (crc << 8) ^
              table_byte[((crc >> 8) ^ data[i]) & 0xff];
    }
    return crc;
}

static inline uint16_t swaplow(uint16_t crc) {
    return
        ((crc & 0xff) << 8) +
        ((crc & 0xff00) >> 8);
}

// This code assumes that integers are stored little-endian.

uint16_t crc16genibus_word(uint16_t crc, void const *mem, size_t len) {
    unsigned char const *data = mem;
    if (data == NULL)
        return 0;
    while (len && ((ptrdiff_t)data & 0x7)) {
        len--;
        crc = (crc << 8) ^
              table_byte[((crc >> 8) ^ *data++) & 0xff];
    }
    crc = swaplow(crc);
    size_t n = len >> 3;
    for (size_t i = 0; i < n; i++) {
        uint64_t word = crc ^ ((uint64_t const *)data)[i];
        crc = table_word[7][word & 0xff] ^
              table_word[6][(word >> 8) & 0xff] ^
              table_word[5][(word >> 16) & 0xff] ^
              table_word[4][(word >> 24) & 0xff] ^
              table_word[3][(word >> 32) & 0xff] ^
              table_word[2][(word >> 40) & 0xff] ^
              table_word[1][(word >> 48) & 0xff] ^
              table_word[0][word >> 56];
    }
    data += n << 3;
    len &= 7;
    crc = swaplow(crc);
    while (len) {
        len--;
        crc = (crc << 8) ^
              table_byte[((crc >> 8) ^ *data++) & 0xff];
    }
    return crc;
}

static uint16_t multmodp(uint16_t a, uint16_t b) {
    uint16_t prod = 0;
    for (;;) {
        if (a & 1) {
            prod ^= b;
            if (a == 1)
                break;
        }
        a >>= 1;
        b = b & 0x8000 ? (b << 1) ^ 0x1021 : b << 1;
    }
    return prod;
}

static uint16_t const table_comb[] = {
    0x0002, 0x0004, 0x0010, 0x0100, 0x1021, 0x3730, 0xb861, 0xaefc, 0x8e29, 0x13fc,
    0x36c4, 0xfd50, 0xaa9e, 0x881c, 0x4458
};

static uint16_t x8nmodp(uintmax_t n) {
    uint16_t xp = 1;
    int k = 3;
    for (;;) {
        if (n & 1)
            xp = multmodp(table_comb[k], xp);
        n >>= 1;
        if (n == 0)
            break;
        if (++k == 15)
            k = 0;
    }
    return xp;
}

uint16_t crc16genibus_comb(uint16_t crc1, uint16_t crc2,
        uintmax_t len2) {
    return multmodp(x8nmodp(len2), crc1) ^ crc2;
}
